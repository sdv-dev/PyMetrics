name: Manual Collection

on:
  workflow_dispatch:
    inputs:
      projects:
        description: 'List of projects or libraries to collect, separated by spaces (e.g. sdv rdt)'
        required: false
        default: ''
      output_folder:
        description: 'ID of the Google Drive Output folder'
        required: false
        default: '10QHbqyvptmZX4yhu2Y38YJbVHqINRr0n'
      max_days:
        description: 'Maximum number of days to collect, starting from today.'
        required: false
        default: '7'
      extras:
        description: 'Extra arguments to pass (e.g. --dry-run --force --start-date --add-metrics)'
        required: false
        default: '--add-metrics'

jobs:
  collect:
    runs-on: ubuntu-latest-large
    steps:
    - uses: actions/checkout@v4
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true
        activate-environment: true
    - name: Install pip and dependencies
      run: |
        uv pip install -U pip
        uv pip install .
    - name: Collect Downloads Data
      run: |
        uv run pymetrics collect-pypi \
          --verbose \
          --projects ${{ github.event.inputs.projects }} \
          ${{ github.event.inputs.max_days && '--max-days ' || '' }} \
          ${{ github.event.inputs.max_days && github.event.inputs.max_days || '' }} \
          --output-folder gdrive://${{ github.event.inputs.output_folder }} \
          ${{ github.event.inputs.extras }}
      env:
        PYDRIVE_CREDENTIALS: ${{ secrets.PYDRIVE_CREDENTIALS }}
        BIGQUERY_CREDENTIALS: ${{ secrets.BIGQUERY_CREDENTIALS }}
